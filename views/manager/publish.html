<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>学生信息管理系统模板</title>
    <link href="/common/css/StudentStyle.css" rel="stylesheet" type="text/css" />
    <link href="/common/datepicker/css/datepicker.min.css" rel="stylesheet" type="text/css" />
    <link href="/common/css/ks.css" rel="stylesheet" type="text/css" />
    <link href="/common/datepicker/css/uikit.min.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="/modal/modal.css">
    <link rel="stylesheet" href="/manager/css/publish.css">
    <script src="/common/js/jquery-2.1.1.min.js"></script>
    <script src="/common/datepicker/js/uikit.min.js"></script>
    <script src="/common/datepicker/js/datepicker.js"></script>
    <script src="/common/datepicker/js/timepicker.min.js"></script>
</head>
<body>
    <div class="banner">
        <div class="bgh">
            <div class="page">
                <div id="logo">
                    <a href="#">
                        <img src="/common/images/school_logo.png" alt="" width="110" height="70" />
                    </a>
                </div>
                <div class="topxx">
                    {{manager.id}}管理员：{{manager.name}}，欢迎您！
                    <a href="/managers/man/{{manager.id}}">我的信息</a>
                    <a href="/exit">安全退出</a>
                </div>
                <div class="blog_nav">
                    <ul>
                         <li><a href="/managers/man/{{manager.id}}">我的信息</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <div class="page">
        <div class="box mtop">
            <div class="leftbox">
                <div class="l_nav2">
                    <div class="ta1">
                        <strong>管理员个人中心</strong>
                        <div class="leftbgbt">
                        </div>
                    </div>
                    <div class="cdlist">
                        <div>
                            <a href="/managers/man/{{manager.id}}">我的信息</a>
                        </div>
                        <div>
                            <a href="javascript:;" id="repairePwd" data-id="{{manager.id}}">修改密码</a>
                        </div>
                    </div>
                    <div class="ta1">
                        <strong>课程管理</strong><div class="leftbgbt2">
                    </div>
                    </div>
                    <div class="cdlist">
                        <div>
                            <a href="/managers/lookcourse">查看课程</a>
                        </div>
                    </div>
                    <div class="ta1">
                        <strong>教师管理</strong><div class="leftbgbt2">
                    </div>
                    </div>
                    <div class="cdlist">
                        <div>
                            <a href="/managers/findTeacher">查看教师</a>
                        </div>
                    </div>
                    <div class="ta1">
                        <strong>学生管理</strong><div class="leftbgbt2">
                    </div>
                    </div>
                    <div class="cdlist">
                        <div>
                            <a href="/managers/findStudent">查看学生</a>
                        </div>
                    </div>
                    <div class="ta1">
                        <strong>教学质量评价管理</strong><div class="leftbgbt2">
                    </div>
                    </div>
                    <div class="cdlist">
                        <div>
                            <a href="/managers/publish">发布教学质量评价</a>
                        </div>
                        <div>
                            <a href="/managers/addTeachEvaluation">增加教学质量评价</a>
                        </div>
                        <div>
                            <a href="/managers/repareEvaluation">修改教学质量评价内容</a>
                        </div>
                    </div>
                    <div class="ta1">
                        <strong>教师得分</strong><div class="leftbgbt2">
                    </div>
                    </div>
                    <div class="cdlist">
                        <div>
                            <a href="/managers/getallevaluato">教师得分查询</a>
                        </div>
                    </div>
                </div>
            </div>
          <div class="rightbox">
            <h2 class="mbx">我的信息 &gt; 教学质量评价管理 &nbsp;&nbsp;&nbsp;</h2>
            <div class="cztable">
                <table width="100%" cellpadding="0" cellspacing="0" id="information">
                    <tr>
                        <td align="center" width="30" rowspan="2">编号</td>
                        <td align="center" width="80" rowspan="2">评价指标</td>
                        <td align="center" width="80" colspan="4">达到等级</td>

                        <td align="center" width="80" rowspan="2" colspan="4">
                            评价期望标准
                        </td>
                    </tr>
                    <tr>
                        <td align="center" width="30">
                            <p>完全达到</p>
                            <p>（优）</p>
                        </td>
                        <td align="center" width="80">
                            <p>大部分达到</p>
                            <p>（良）</p>
                        </td>
                        <td align="center" width="80">
                            <p>基本达到</p>
                            <p>（中）</p>
                        </td>
                        <td align="center" width="80">
                            <p>部分达到</p>
                            <p>（差）</p>
                        </td>
                    </tr>
                    {{each manager.teachEvaluations}}
                        <tr>
                            <td align="center" width="30">{{$value.type}}</td>
                            <td align="center" width="80">{{$value.numberQuota}}</td>
                            {{each manager.levels}}
                                <td align="center" width="80">{{$value.grade}}</td>
                            {{/each}}
                            <td align="left" width="300">
                                {{each $value.contents}}
                                   {{if($value)}}
                                        <p>{{$index+1}}、{{$value}}</p>
                                    {{/if}}
                                {{/each}}
                            </td>
                        </tr>
                    {{/each}}
                </table>
            </div>
        </div>
        <div class="rightbox" id="publish_box">
            <h2 class="mbx">发布管理 &nbsp;&nbsp;&nbsp;</h2>
            <div class="cztable">
                <table width="100%" cellpadding="0" cellspacing="0" id="publish_information">
                    <tr>
                        <td align="center" width="80">时间跨度</td>
                        <td align="left" width="80" >
                            开始时间：<input type="text" name="start_time" class="filter_inp" id="start_time"  data-uk-datepicker="{format:'YYYY.DD.MM'}">
                        </td>
                        <td align="center" width="80" colspan="1">
                            结束时间：<input type="text" name="end_time" class="filter_inp"  id="end_time"  data-uk-datepicker="{format:'YYYY.DD.MM'}">
                        </td>
                    </tr>
                    <tr>
                        <td align="center" width="80">指定发布的届</td>
                        <td align="left" width="80" colspan="3">
                            <select name="p_session" id="p_session" style="margin-left: 20px">
                                {{each manager.sessions}}
                                    <option value="{{$value.id}}">{{$value.session}}届</option>
                                {{/each}}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" width="80">指定发布的系</td>
                        <td align="left" width="80" colspan="3">
                            <select name="p_department" id="p_department" style="margin-left: 20px">
                                {{each manager.departments}}
                                    <option value="{{$value.id}}">{{$value.name}}</option>
                                {{/each}}
                            </select>
                        </td>

                    </tr>
                    <tr>
                        <td align="center" width="80">发布提示内容</td>
                        <td align="left" width="80" colspan="3">
                            <textarea name="" id="" cols="30" rows="4" style="margin-left:20px" class="pub_info"></textarea>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" width="80">tips</td>
                        <td align="left" width="80" colspan="3">
                            <input type="text" placeholder="tips" class="inp_tips">
                        </td>
                    </tr>
                    <tr>
                        <td align="center" width="80">确认发布</td>
                        <td align="left" width="80" colspan="2">
                            <input type="radio" value="1" class="confirm_pub ">
                        </td>
                    </tr>
                </table>
            </div>
            <div class="submit">
                <a href="javascript:;" id="publish">发布</a>
            </div>
        </div>
        <div class="modal">
        </div>
        <div class="pwd">
            <div class="pwd_header">
                <h1>修改密码</h1>
                <span class="close">X</span>
            </div>
            <div class="pwd_body">
                <p>
                    <label for="username">工号</label>
                    <input type="text" name="username" id="username" placeholder="password">
                </p>
                <p>
                    <label for="password">新密码</label>
                    <input type="password" name="password" id="password" placeholder="password">
                    <label class="new_report"></label>
                </p>
                <p>
                    <label for="password">确认密码</label>
                    <input type="password" name="confirmpassword" id="confirmpassword" placeholder="confirmpassword">
                    <label class="confirm_report"></label>
                </p>
            </div>
            <div class="pwd_footer">
                <button class="btn" id="reset">取消</button>
                <button class="btn" id="repaire">修改</button>
            </div>
        </div>
    <script>
        $(function(){
            $("#password").blur(function(){
                var pwd = $(this).val()
                if( pwd.length == 0 || pwd.length < 5){
                    $(".new_report").html("长度不够").addClass("error")
                    return false
                }else{
                    $(".new_report").html("").removeClass("error")

                }
            })
            $("#confirmpassword").blur(function(){
                pwd = $(this).val()
                if( pwd.length == 0 || pwd.length < 5){
                    $(".confirm_report").html("长度不够").addClass("error")
                    return false
                }else{
                    $(".confirm_report").html("").removeClass("error")
                }
            })

            $("#repairePwd").on("click",function(){
                $(".modal").show()
                $($(".pwd")[0]).animate({
                    top:"100px",
                },500)
                var id = parseInt($("#repairePwd").attr("data-id"))
                $("#username").val(id).addClass("disabled").attr("disabled","true")
            })

            function resetClick() {
                $(".modal").hide()
                $($(".pwd")[0]).animate({
                    top:"-400px",
                },500)
                $(".confirm_report").html("").prev("input[type='password']").val("").removeClass("error")
                $(".new_report").html("").prev("input[type='password']").val("").removeClass("error")
            }

            function  closeClick() {
                $(".modal").hide()
                $($(".pwd")[0]).animate({
                    top:"-400px",
                },500)
                $(".confirm_report").html("").prev("input[type='password']").val("").removeClass("error")
                $(".new_report").html("").prev("input[type='password']").val("").removeClass("error")
            }

            function modalClick() {
                $(".modal").hide()
                $($(".pwd")[0]).animate({
                    top:"-400px",
                },500)
                $(".confirm_report").html("").prev("input[type='password']").val("").removeClass("error")
                $(".new_report").html("").prev("input[type='password']").val("").removeClass("error")
            }
            $("#reset").on("click",resetClick)
            $(".close").on("click",closeClick)
            $(".modal").on("click",modalClick)

            function dorepaire(){
                var new_p = $("#password").val()
                var new_c = $("#confirmpassword").val()
                if(new_p !== new_c){
                    $(".new_report").html("两次输入密码不同").addClass("error")
                    $(".confirm_report").html("两次输入密码不同").addClass("error")
                    return
                }
                $("#repaire").off("click").addClass("notDo")
                $("#reset").addClass("notDo").off("click")
                $(".close").off("click")
                $(".modal").off("click")
                $(".new_report").html("").removeClass("error")
                $(".confirm_report").html("").removeClass("error")
                var id = parseInt($("#repairePwd").attr("data-id"))
                $.ajax({
                    url:"/teachers/dorepaire",
                    type:"post",
                    data:{id:id,newpassword:new_p,confirmpassword:new_c},
                    dataType:"json",
                    processData:true,
                    traditional:true,
                    success:function(res){
                        console.log(res)
                        if(res.status == 200){
                            setTimeout(function(){
                                alert("修改成功")
                                $("#repaire").removeClass("notDo").on("click",dorepaire)
                                $("#reset").on("click",resetClick).removeClass("notDo")
                                $(".close").on("click",closeClick)
                                $(".modal").on("click",modalClick)
                                modalClick()
                            },2000)
                        }
                    },
                    error:function(err){
                        if(err){
                            alert("修改失败")
                            $("#repaire").removeClass("notDo").on("click",dorepaire)
                            $("#reset").on("click",resetClick).removeClass("notDo")
                            $(".close").on("click",closeClick)
                            $(".modal").on("click",modalClick)
                        }
                    }
                })
            }
            $("#repaire").on("click",dorepaire)

            $("#departement").change(function(){
              var did = parseInt($(this).val())
                $.ajax({
                    url:"/managers/getCourse",
                    type:"post",
                    data:{did},
                    dataType:"json",
                    accepts:"application/json",
                    traditional:false,
                    processData:true,
                    success:function(res){
                       if(res.status === 200){
                           var  html =  `
                                        <option value="">---课程名---</option>
                                    `
                           for(var i=0;i<res.data.length;i++){
                               html += `
                                        <option value="${res.data[i].id}">${res.data[i].name}</option>
                                    `
                           }
                            $("#course").html(html)
                       }
                    },
                    error:function(err){
                        console.log(err)
                    }
                })
            })

            $("#course").change(function(){

                var cid = $(this).val()
                var did = $("#departement").val()
                $.ajax({
                    url:"/managers/getDepartmentCourse",
                    type:"post",
                    data:{cid,did},
                    dataType:"json",
                    accepts:"application/json",
                    traditional:false,
                    processData:true,
                    success:function(res){
                        if(res.status === 200){
                            var html = `
                                 <tr>
                                    <th align="center" width="80">课程ID</th>
                                    <th align="center" width="80">课程名</th>
                                    <th align="center" width="80">所属系</th>
                                </tr>
                            `
                            for(var i=0; i < res.data.length;i++){
                                html += `
                                     <tr>
                                        <td align="center" width="80">${res.data[i].courseID}</td>
                                        <td align="center" width="80">${res.data[i].course}</td>
                                        <td align="center" width="80">${res.data[i].department}</td>
                                    </tr>
                                `
                            }
                            $("#information").html("").html(html)
                        }
                    },
                    error:function(err){
                        console.log(err)
                    }
                })
            })

            $(".filter_inp").keyup(function(){
                var findValue = $(this).val()
                $.ajax({
                    url:"/managers/filterTeacher",
                    type:"post",
                    data:{findValue},
                    dataType:"json",
                    processData:true,
                    accepts:"application/json",
                    success:function(res){
                        if(res.status === 200){
                            // console.log(res.data)
                            var html = `
                                <tr>
                                    <th align="center" width="80">教师工号</th>
                                    <th align="center" width="80">教师姓名</th>
                                    <th align="center" width="80">教师性别</th>
                                    <th align="center" width="80">教师联系电话</th>
                                    <th align="center" width="80">教师联系地址</th>
                                    <th align="center" colspan="2" width="100">操作</th>
                                </tr>
                            `
                            for(var i=0;i < res.data.length;i++){
                                html += `
                                     <tr>
                                        <td align="center" width="80">${res.data[i]["id"]}</td>
                                        <td align="center" width="80">${res.data[i]["teachername"]}</td>
                                        <td align="center" width="80">${res.data[i]["teacherSex"]}</td>
                                        <td align="center" width="80">${res.data[i]["teacherPhone"]}</td>
                                        <td align="center" width="80">${res.data[i]["address"]}</td>
                                        <td align="center" width="50"><a href="/managers/modify/teacher/${res.data[i]["id"]}" class="btn_op" id="btn_rapire" >修改</a></td>
                                        <td align="center" width="50"><a href="/managers/detail/teacher/${res.data[i]["id"]}" class="btn_op" id="btn_look" >查看详情</a></td>
                                    </tr>

                                `
                            }
                            $("#information").html("").html(html)
                        }
                    },
                    error:function(err){
                        console.log(err)
                    }
                })
            })

            var departmentFilter,classesFilter,courseFilter,ageFilter,sexFilter

            $("#departmentFilter").change(function(){
                departmentFilter = $(this).val()
            })
            $("#classesFilter").change(function(){
                classesFilter = $(this).val()
            })
            $("#courseFilter").change(function(){
                courseFilter = $(this).val()
            })
            $("#ageFilter").change(function(){
                ageFilter = $(this).val()
            })
            $("#sexFilter").change(function(){
                sexFilter = $(this).val()

            })
            $(".btnFilter").on("click",function(){
                $.ajax({
                    url:'/managers/filterStudent',
                    type:"POST",
                    data:{
                        departmentFilter,classesFilter,courseFilter,ageFilter,sexFilter
                    },
                    dataType:"json",
                    processData:true,
                    traditional:false,
                    ContentType:"application/json",
                    success:function(res){
                        if(res.status === 200){
                            console.log(res.data.studentList)
                            var html = `

                                 <tr>
                                <th align="center" width="80">学生学号</th>
                                <th align="center" width="80">学生姓名</th>
                                <th align="center" width="80">学生性别</th>
                                <th align="center" width="80">学生所属系</th>
                                <th align="center" width="80">学生所属班级</th>
                                <th align="center" width="80">学生联系电话</th>
                                <th align="center" width="80">学生联系地址</th>
                                <th align="center" colspan="2" width="100">操作</th>
                            </tr>
                            `
                            for(let i=0;i<res.data.studentList[0].length;i++){
                                html +=`
                                        <tr>
                                            <td align="center" width="80">${res.data.studentList[0][i]["id"]}</td>
                                            <td align="center" width="80">${res.data.studentList[0][i]["name"]}</td>
                                            <td align="center" width="80">${res.data.studentList[0][i]["sex"]}</td>
                                            <td align="center" width="80">${res.data.studentList[0][i]["department"]}</td>
                                            <td align="center" width="80">${res.data.studentList[0][i]["class"]}</td>
                                            <td align="center" width="80">${res.data.studentList[0][i]["phone"]}</td>
                                            <td align="center" width="80">${res.data.studentList[0][i]["address"]}</td>
                                            <td align="center" width="50"><a href="/managers/modify/student/${res.data.studentList[0][i]["id"]}" class="btn_op" id="btn_rapire">修改</a></td>
                                            <td align="center" width="50"><a href="/managers/detail/student/${res.data.studentList[0][i]["id"]}" class="btn_op" id="btn_look" >查看详情</a></td>
                                        </tr>
                                            `
                            }
                            $("#information").html("").html(html)
                        }
                    },
                    error:function(err){
                        console.log(err)
                    }
                })

            })

            $.ajax({
                url:'/managers/departmentCourse',
                type:"POST",
                dataType:"json",
                ContentType:"application/json",
                success:function(res){
                    var department_html =  `
                          <option value="">--根据系过滤--</option>
                    `
                    var course_html = `
                        <option value="">--根据课程过滤--</option>
                    `
                    var class_html = `
                            <option value="">--根据班级过滤--</option>
                    `
                    if(res.status === 200){
                       for(var i=0; i < res.data.department.length;i++){
                           department_html += `
                            <option value="${res.data.department[i]["id"]}">${res.data.department[i]["name"]}</option>
                           `
                       }
                        for(var i=0;i<res.data.course.length;i++){
                            course_html += `
                            <option value="${res.data.course[i]["id"]}">${res.data.course[i]["name"]}</option>
                           `
                        }
                        for(var i=0;i<res.data.classes.length;i++){
                            class_html += `
                            <option value="${res.data.classes[i]["id"]}">${res.data.classes[i]["name"]}</option>
                           `
                        }
                    }
                    $("#departmentFilter").html("").html(department_html)
                    $("#courseFilter").html("").html(course_html)
                    $("#classesFilter").html("").html(class_html)
                },
                error:function(err){
                    console.log(err)
                }
            })

            var label = {
                inp_tips:{
                    flag:0,
                    classname:'inp_tips'
                },
                pub_info:{
                    flag:0,
                    classname:'pub_info'
                },
                confirm_pub:{
                    flag:0,
                    classname:'confirm_pub'
                }
            }

            $(".inp_tips").blur(function(){
                var val = $(this).val()

                if(val.trim().length <= 0 ){
                    $(".inp_tips").addClass("tip_error")
                    label.inp_tips.flag = 0
                }else{
                    $(this).removeClass("tip_error")
                    label.inp_tips.flag = 1
                }
            })

            $(".pub_info").blur(function(){
                var val = $(this).val()
                if(val.trim().length <= 0 ){
                    $(this).addClass("tip_error")
                    label.pub_info.flag = 0
                }else{
                    $(this).removeClass("tip_error")
                    label.pub_info.flag = 1
                }
            })

            //点击发布

            function p_publish(){
                var timestamp = 0,
                    session = 0,
                    department = 0,
                    p_msg = '',
                    tip = '',
                    is_publish = 0;

                var start_time = $("#start_time").val(),
                    end_time = $("#end_time").val();
                var end= (new Date(end_time)).valueOf(),
                    start = (new Date(start_time)).valueOf();
                session = $("#p_session").val();
                department = $("#p_department").val();
                p_msg = $(".pub_info").eq(0).val();
                tip = $(".inp_tips").eq(0).val();
                is_publish = $(".confirm_pub").eq(0).val();

                timestamp = end - start;
                if(timestamp < 0){
                    alert("请输入正确的日期范围!")
                    return;
                }

                if(p_msg === ""){
                    alert("请输入发布提示内容")
                    return;
                }
                if(tip === ""){
                    alert("请输入tips")
                    return;
                }
                alert("准备发送")


                $.ajax({
                    url:'/managers/doPublish',
                    type:'post',
                    data:{
                        start,
                        end,
                        session,
                        department,
                        p_msg,
                        tip ,
                        is_publish
                    },
                    dataType:"json",
                    processData:true,
                    tranditional:false,
                    ContentType:"application/json",
                    success:function(res){
                        if(res.status === 200){
                            setTimeout(function(){
                                $("#publish").on("click")
                                window.location.href=res.path;
                            },3000)
                        }

                    },
                    error:function(err){
                        alert("已发布，不能再次发布！")
                        console.log(err)
                    }
                })
            }
            $("#publish").on("click",p_publish)

        })
    </script>
</body>
</html>
